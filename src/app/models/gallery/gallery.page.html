<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Mi Galería</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="openSearchModal()">
        <ion-icon name="search"></ion-icon>
      </ion-button>
      <ion-button (click)="openSortModal()">
        <ion-icon name="filter"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Mi Galería</ion-title>
    </ion-toolbar>
  </ion-header>

  <!-- Estadísticas de la galería -->
  <ion-card class="stats-card" *ngIf="photos.length > 0">
    <ion-card-content>
      <ion-grid>
        <ion-row>
          <ion-col size="4" class="stat-item">
            <div class="stat-number">{{photos.length}}</div>
            <div class="stat-label">Fotos</div>
          </ion-col>
          <ion-col size="4" class="stat-item">
            <div class="stat-number">{{getTotalSize()}}</div>
            <div class="stat-label">Almacenadas</div>
          </ion-col>
          <ion-col size="4" class="stat-item">
            <div class="stat-number">{{getRecentPhotos()}}</div>
            <div class="stat-label">Esta semana</div>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>

  <!-- Estado vacío -->
  <div class="empty-state" *ngIf="photos.length === 0 && !isLoading">
    <ion-icon name="camera-outline" class="empty-icon"></ion-icon>
    <h2>Tu galería está vacía</h2>
    <p>Comienza capturando tu primera foto</p>
    <ion-button (click)="takePhoto()" expand="block" fill="solid">
      <ion-icon name="camera" slot="start"></ion-icon>
      Tomar Foto
    </ion-button>
  </div>

  <!-- Loading spinner -->
  <div class="loading-container" *ngIf="isLoading">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Cargando fotos...</p>
  </div>

  <!-- Galería de fotos -->
  <div class="photo-grid" *ngIf="photos.length > 0">
    <div 
      class="photo-item" 
      *ngFor="let photo of filteredPhotos; trackBy: trackByPhotoId"
      (click)="openPhotoDetail(photo)">
      
      <img 
        [src]="photo.url" 
        [alt]="photo.title"
        (error)="onImageError($event, photo)"
        loading="lazy">
      
      <div class="photo-overlay">
        <div class="photo-info">
          <h3>{{photo.title}}</h3>
          <p>{{photo.createdAt | date:'short'}}</p>
        </div>
        
        <div class="photo-actions">
          <ion-button fill="clear" size="small" (click)="sharePhoto(photo, $event)">
            <ion-icon name="share-outline"></ion-icon>
          </ion-button>
          <ion-button fill="clear" size="small" (click)="deletePhoto(photo, $event)">
            <ion-icon name="trash-outline" color="danger"></ion-icon>
          </ion-button>
        </div>
      </div>
    </div>
  </div>

  <!-- Botón flotante para agregar fotos -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button color="primary">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
    <ion-fab-list side="top">
      <ion-fab-button (click)="takePhoto()">
        <ion-icon name="camera"></ion-icon>
      </ion-fab-button>
      <ion-fab-button (click)="selectFromGallery()">
        <ion-icon name="images"></ion-icon>
      </ion-fab-button>
    </ion-fab-list>
  </ion-fab>

</ion-content>

<!-- Modal de detalle de foto -->
<ion-modal [isOpen]="showPhotoDetail" (didDismiss)="closePhotoDetail()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>{{selectedPhoto?.title}}</ion-title>
        <ion-buttons slot="start">
          <ion-button (click)="closePhotoDetail()">
            <ion-icon name="arrow-back"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-buttons slot="end">
          <ion-button (click)="editPhotoInfo()">
            <ion-icon name="create-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    
    <ion-content>
      <div class="photo-detail" *ngIf="selectedPhoto">
        <div class="photo-container">
          <img [src]="selectedPhoto.url" [alt]="selectedPhoto.title">
        </div>
        
        <ion-card>
          <ion-card-content>
            <h2>{{selectedPhoto.title}}</h2>
            <p *ngIf="selectedPhoto.description">{{selectedPhoto.description}}</p>
            
            <div class="photo-metadata">
              <ion-item lines="none">
                <ion-icon name="calendar-outline" slot="start"></ion-icon>
                <ion-label>{{selectedPhoto.createdAt | date:'full'}}</ion-label>
              </ion-item>
              
              <ion-item lines="none" *ngIf="selectedPhoto.metadata.width">
                <ion-icon name="resize-outline" slot="start"></ion-icon>
                <ion-label>{{selectedPhoto.metadata.width}} x {{selectedPhoto.metadata.height}}</ion-label>
              </ion-item>
              
              <ion-item lines="none">
                <ion-icon name="document-outline" slot="start"></ion-icon>
                <ion-label>{{selectedPhoto.metadata.format.toUpperCase()}}</ion-label>
              </ion-item>
            </div>
            
            <div class="detail-actions">
              <ion-button expand="block" fill="outline" (click)="sharePhoto(selectedPhoto)">
                <ion-icon name="share-outline" slot="start"></ion-icon>
                Compartir
              </ion-button>
              
              <ion-button expand="block" fill="outline" (click)="downloadPhoto(selectedPhoto)">
                <ion-icon name="download-outline" slot="start"></ion-icon>
                Descargar
              </ion-button>
              
              <ion-button expand="block" color="danger" fill="outline" (click)="deletePhoto(selectedPhoto)">
                <ion-icon name="trash-outline" slot="start"></ion-icon>
                Eliminar
              </ion-button>
            </div>
          </ion-card-content>
        </ion-card>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Modal de edición -->
<ion-modal [isOpen]="showEditModal" (didDismiss)="closeEditModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Editar Foto</ion-title>
        <ion-buttons slot="start">
          <ion-button (click)="closeEditModal()">Cancelar</ion-button>
        </ion-buttons>
        <ion-buttons slot="end">
          <ion-button (click)="savePhotoInfo()" [disabled]="!editForm.title">
            Guardar
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    
    <ion-content>
      <div class="edit-form" *ngIf="editForm">
        <ion-card>
          <ion-card-content>
            <ion-item>
              <ion-label position="stacked">Título</ion-label>
              <ion-input [(ngModel)]="editForm.title" placeholder="Título de la foto"></ion-input>
            </ion-item>
            
            <ion-item>
              <ion-label position="stacked">Descripción</ion-label>
              <ion-textarea [(ngModel)]="editForm.description" placeholder="Descripción opcional"></ion-textarea>
            </ion-item>
          </ion-card-content>
        </ion-card>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>