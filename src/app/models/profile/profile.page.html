<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Mi Perfil</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="openSettings()">
        <ion-icon name="settings-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Mi Perfil</ion-title>
    </ion-toolbar>
  </ion-header>

  <!-- Header del perfil -->
  <div class="profile-header">
    <div class="avatar-container" (click)="changeAvatar()">
      <img 
        [src]="user?.photoURL || 'assets/images/default-avatar.png'" 
        [alt]="user?.displayName"
        class="avatar">
      <div class="avatar-edit">
        <ion-icon name="camera"></ion-icon>
      </div>
    </div>
    
    <h1 class="user-name">{{user?.displayName}}</h1>
    <p class="user-email">{{user?.email}}</p>
    
    <div class="join-date" *ngIf="user?.createdAt">
      <ion-icon name="calendar-outline"></ion-icon>
      Miembro desde {{user.createdAt | date:'MMM yyyy'}}
    </div>
  </div>

  <!-- Estadísticas del usuario -->
  <div class="profile-stats">
    <div class="stat-card">
      <span class="stat-number">{{photoCount}}</span>
      <span class="stat-label">Fotos</span>
    </div>
    
    <div class="stat-card">
      <span class="stat-number">{{storageUsed}}</span>
      <span class="stat-label">Almacenamiento</span>
    </div>
    
    <div class="stat-card">
      <span class="stat-number">{{daysActive}}</span>
      <span class="stat-label">Días activo</span>
    </div>
  </div>

  <!-- Información de la cuenta -->
  <div class="account-section">
    <ion-card>
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="person-outline"></ion-icon>
          Información de la cuenta
        </ion-card-title>
      </ion-card-header>
      
      <ion-card-content>
        <ion-item lines="none">
          <ion-icon name="mail-outline" slot="start"></ion-icon>
          <ion-label>
            <h3>Correo electrónico</h3>
            <p>{{user?.email}}</p>
          </ion-label>
          <ion-button fill="clear" slot="end" (click)="editEmail()">
            <ion-icon name="create-outline"></ion-icon>
          </ion-button>
        </ion-item>
        
        <ion-item lines="none">
          <ion-icon name="person-outline" slot="start"></ion-icon>
          <ion-label>
            <h3>Nombre de usuario</h3>
            <p>{{user?.displayName}}</p>
          </ion-label>
          <ion-button fill="clear" slot="end" (click)="editDisplayName()">
            <ion-icon name="create-outline"></ion-icon>
          </ion-button>
        </ion-item>
        
        <ion-item lines="none">
          <ion-icon name="key-outline" slot="start"></ion-icon>
          <ion-label>
            <h3>Contraseña</h3>
            <p>••••••••</p>
          </ion-label>
          <ion-button fill="clear" slot="end" (click)="changePassword()">
            <ion-icon name="create-outline"></ion-icon>
          </ion-button>
        </ion-item>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Actividad reciente -->
  <div class="activity-section" *ngIf="recentActivity.length > 0">
    <ion-card>
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="time-outline"></ion-icon>
          Actividad reciente
        </ion-card-title>
      </ion-card-header>
      
      <ion-card-content>
        <ion-list>
          <ion-item *ngFor="let activity of recentActivity" lines="none">
            <ion-icon [name]="getActivityIcon(activity.type)" slot="start"></ion-icon>
            <ion-label>
              <h3>{{activity.title}}</h3>
              <p>{{activity.date | date:'short'}}</p>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Acciones del perfil -->
  <div class="profile-actions">
    <ion-button expand="block" fill="outline" (click)="exportData()">
      <ion-icon name="download-outline" slot="start"></ion-icon>
      Exportar mis datos
    </ion-button>
    
    <ion-button expand="block" fill="outline" (click)="syncData()">
      <ion-icon name="sync-outline" slot="start"></ion-icon>
      Sincronizar datos
    </ion-button>
    
    <ion-button expand="block" fill="outline" color="warning" (click)="deleteAccount()">
      <ion-icon name="warning-outline" slot="start"></ion-icon>
      Eliminar cuenta
    </ion-button>
    
    <ion-button expand="block" fill="outline" color="danger" (click)="logout()" class="logout-button">
      <ion-icon name="log-out-outline" slot="start"></ion-icon>
      Cerrar sesión
    </ion-button>
  </div>

</ion-content>

<!-- Modal para editar nombre -->
<ion-modal [isOpen]="showEditNameModal" (didDismiss)="closeEditNameModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Editar nombre</ion-title>
        <ion-buttons slot="start">
          <ion-button (click)="closeEditNameModal()">Cancelar</ion-button>
        </ion-buttons>
        <ion-buttons slot="end">
          <ion-button (click)="saveDisplayName()" [disabled]="!newDisplayName.trim()">
            Guardar
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    
    <ion-content>
      <ion-card>
        <ion-card-content>
          <ion-item>
            <ion-label position="stacked">Nombre de usuario</ion-label>
            <ion-input 
              [(ngModel)]="newDisplayName" 
              placeholder="Ingresa tu nuevo nombre"
              maxlength="50">
            </ion-input>
          </ion-item>
        </ion-card-content>
      </ion-card>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Modal para cambiar contraseña -->
<ion-modal [isOpen]="showChangePasswordModal" (didDismiss)="closeChangePasswordModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Cambiar contraseña</ion-title>
        <ion-buttons slot="start">
          <ion-button (click)="closeChangePasswordModal()">Cancelar</ion-button>
        </ion-buttons>
        <ion-buttons slot="end">
          <ion-button (click)="updatePassword()" [disabled]="!isPasswordFormValid()">
            Cambiar
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    
    <ion-content>
      <ion-card>
        <ion-card-content>
          <ion-item>
            <ion-label position="stacked">Contraseña actual</ion-label>
            <ion-input 
              type="password" 
              [(ngModel)]="passwordForm.currentPassword" 
              placeholder="Contraseña actual">
            </ion-input>
          </ion-item>
          
          <ion-item>
            <ion-label position="stacked">Nueva contraseña</ion-label>
            <ion-input 
              type="password" 
              [(ngModel)]="passwordForm.newPassword" 
              placeholder="Nueva contraseña">
            </ion-input>
          </ion-item>
          
          <ion-item>
            <ion-label position="stacked">Confirmar nueva contraseña</ion-label>
            <ion-input 
              type="password" 
              [(ngModel)]="passwordForm.confirmPassword" 
              placeholder="Confirmar contraseña">
            </ion-input>
          </ion-item>
          
          <div class="password-requirements" *ngIf="passwordForm.newPassword">
            <ion-text color="medium">
              <p><small>La contraseña debe tener al menos 6 caracteres</small></p>
            </ion-text>
          </div>
        </ion-card-content>
      </ion-card>
    </ion-content>
  </ng-template>
</ion-modal>